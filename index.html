<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <title>新增紀錄-CASHU</title>
  <script type="module" crossorigin src="/CASHU-m/assets/main-C8Kcf5eU.js"></script>
  <link rel="stylesheet" crossorigin href="/CASHU-m/assets/main-Ch1DFniR.css">
</head>

<body>
  <div class="container-fluid mobile-frame bg-white" style="padding-bottom: 109px">
    <img src="/CASHU-m/assets/Status%20bar-C_-zPuPq.svg" alt="statusbar" class="object-fit-cover">      <main>
        <div class="py-4 d-flex justify-content-between align-items-center">
          <i data-lucide="chevron-left" class="icon-24"></i>
          新增紀錄
          <i data-lucide="chevron-right" class="icon-24 icon-transparent"></i>
        </div>
        <div class="position-relative">
          <input type="text" id="consult_datetime" class="form-control py-4 px-5" readonly />
          <span id="calendar_icon" class="position-absolute top-50 end-0 translate-middle-y me-5"
            style="cursor: pointer">
            <i data-lucide="calendar"></i>
          </span>
        </div>

        <!--支出/收入/轉帳-->
        <div class="addrecord">
          <ul class="nav nav-underline border-bottom text-center" id="account-tab" role="tablist">
            <li class="nav-item tab-three">
              <a class="nav-link active" id="expenseAmount-tab" data-bs-toggle="tab" href="#expenseAmount" role="tab"
                aria-controls="expenseAmount" aria-selected="true">支出</a>
            </li>
            <li class="nav-item tab-three">
              <a class="nav-link" id="passengers-tab" data-bs-toggle="tab" href="#passengers" role="tab"
                aria-controls="passengers" aria-selected="false">收入</a>
            </li>
            <li class="nav-item tab-three">
              <a class="nav-link" id="passengers-tab" data-bs-toggle="tab" href="#passengers" role="tab"
                aria-controls="passengers" aria-selected="false">轉帳</a>
            </li>
          </ul>

          <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="expenseAmount" role="tabpanel"
              aria-labelledby="expenseAmount-tab" tabindex="0">
              <section class="py-5 d-flex align-items-center flex-column">
                <div class="categoy-icon category-icon-xl mb-4">
                  <img src="data:image/svg+xml,%3csvg%20width='48'%20height='48'%20viewBox='0%200%2048%2048'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M43.4559%2013.4094C43.8147%2014.276%2043.9996%2015.2049%2043.9996%2016.1429C44.0019%2017.2521%2043.7447%2018.3466%2043.2484%2019.3387C42.7524%2020.3309%2042.0313%2021.1933%2041.1424%2021.8571V36.1428C41.1424%2036.9006%2040.8413%2037.6274%2040.3056%2038.1631C39.7699%2038.6988%2039.043%2039%2038.2853%2039H19.7139V9H36.8567C37.7947%209%2038.7236%209.18474%2039.5901%209.54371C40.4567%209.90269%2041.2441%2010.4288%2041.9076%2011.0921C42.5707%2011.7554%2043.097%2012.5428%2043.4559%2013.4094Z'%20fill='%23FF840A'/%3e%3cpath%20d='M31.1429%2016.1429C31.1429%2015.2049%2030.9581%2014.276%2030.5991%2013.4094C30.2402%2012.5428%2029.714%2011.7554%2029.0508%2011.0921C28.3875%2010.4288%2027.6001%209.90269%2026.7335%209.54371C25.8668%209.18474%2024.938%209%2024%209H11.1429C9.64368%209%208.18254%209.47169%206.96634%2010.3483C5.75017%2011.2249%204.84062%2012.4619%204.36655%2013.8841C3.89247%2015.3063%203.8779%2016.8417%204.3249%2018.2726C4.77191%2019.7036%205.65781%2020.9576%206.85714%2021.8571V36.1428C6.85714%2036.9006%207.15817%2037.6274%207.69397%2038.1631C8.2298%2038.6988%208.95651%2039%209.71428%2039H25.4286C26.1863%2039%2026.9131%2038.6988%2027.4489%2038.1631C27.9847%2037.6274%2028.2857%2036.9006%2028.2857%2036.1428V21.8571C29.1745%2021.1933%2029.8957%2020.3309%2030.3918%2019.3387C30.8879%2018.3466%2031.1451%2017.2521%2031.1429%2016.1429Z'%20fill='%23FFC56D'/%3e%3c/svg%3e" alt="早餐icon" class="" />
                </div>
                <p>早餐 <i data-lucide="pencil" class="icon-15 ms-2"></i></p>
              </section>
              <!--input-->
              <section>
                <ul class="row custom-gap mb-4">
                  <li class="col-6 pe-4 mb-7">
                    <input type="text" id="name" class="form-control input-select" placeholder="名稱"
                      style="height: 44px" />
                  </li>
                  <li class="col-6 mb-7">
                    <input type="text" id="amount" class="form-control" inputmode="none" placeholder="$0" readonly
                      style="height: 44px" />
                  </li>
                  <li class="col-6 pe-4">
                    <div class="position-relative">
                      <button type="button"
                        class="btn btn-outline-primary input-select w-100 text-start rounded-12 d-flex align-items-center"
                        id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false" style="height: 44px">
                        現金
                        <span id="calendar_icon" class="position-absolute top-50 end-0 translate-middle-y me-5"
                          style="cursor: pointer">
                          <i data-lucide="chevron-right"></i>
                        </span>
                      </button>
                    </div>
                  </li>
                  <li class="col-6">
                    <div class="position-relative">
                      <button type="button"
                        class="btn btn-outline-primary input-select w-100 text-start rounded-12 d-flex align-items-center"
                        id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false" style="height: 44px">
                        生活開銷
                        <span id="calendar_icon" class="position-absolute top-50 end-0 translate-middle-y me-5"
                          style="cursor: pointer">
                          <i data-lucide="chevron-right"></i>
                        </span>
                      </button>
                    </div>
                  </li>
                </ul>
                <div class="form-floating">
                  <textarea class="form-control rounded-12 " placeholder="Leave a comment here" id="floatingTextarea2"
                    style="height: 200px; resize: none"></textarea>
                  <label for="floatingTextarea2">請輸入備註</label>
                </div>
              </section>
            </div>

            <!--收入-->
            <div class="tab-pane fade frequent-traveler" id="expenseAmount" role="tabpanel"
              aria-labelledby="expenseAmount-tab" tabindex="0"></div>
          </div>
        </div>

        <!--底部彈開按鈕+計算機-->
        <!-- Offcanvas -->
        <div class="offcanvas-bottom mobile-frame" id="calculator">
          <!-- 部分展開 -->
          <div class="partial-view" id="partialView">
            <div class="expand-handle"></div>
            <div class="d-flex gap-4 align-items-center">
              <button type="button"
                class="btn btn-outline-primary rounded-pill flex-grow-1 d-flex align-items-center justify-content-center"
                onclick="event.stopPropagation(); voiceFunction()" style="height: 44px">
                <i data-lucide="mic"></i>
              </button>
              <button type="button"
                class="btn btn-outline-primary rounded-pill flex-grow-1 d-flex align-items-center justify-content-center"
                onclick="event.stopPropagation(); qrFunction()" style="height: 44px">
                <i data-lucide="qr-code" class="align-middle"></i>
              </button>
              <button type="button"
                class="btn btn-primary rounded-pill d-flex align-items-center justify-content-center"
                style="width: 165.5px; height: 44px" onclick="event.stopPropagation(); saveFunction()">
                儲存
              </button>
            </div>
            <img src="data:image/svg+xml,%3csvg%20width='343'%20height='34'%20viewBox='0%200%20343%2034'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20width='144'%20height='5'%20rx='2.5'%20transform='matrix(-1%200%200%201%20244%2021)'%20fill='black'/%3e%3c/svg%3e" alt="statusbar"
    class="object-fit-cover position-absolute  bottom-0 start-50 translate-middle-x $zindex-fixed:2000;">          </div>

          <!-- 完全展開 -->
          <div class="calculator-full" id="calculatorFull">
            <div class="calculator-header gap-4 mb-4">
              <button type="button" class="btn btn-outline-primary rounded-pill">
                語音記帳
              </button>
              <button type="button" class="btn btn-outline-primary rounded-pill">
                發票記帳
              </button>
            </div>

            <div class="calculator-grid">
              <button class="calc-btn number" onclick="inputNumber('7')">
                7
              </button>
              <button class="calc-btn number" onclick="inputNumber('8')">
                8
              </button>
              <button class="calc-btn number" onclick="inputNumber('9')">
                9
              </button>
              <button class="calc-btn operator" onclick="inputOperator('÷')">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M5%2012H19M13%206C13%206.55228%2012.5523%207%2012%207C11.4477%207%2011%206.55228%2011%206C11%205.44772%2011.4477%205%2012%205C12.5523%205%2013%205.44772%2013%206ZM13%2018C13%2018.5523%2012.5523%2019%2012%2019C11.4477%2019%2011%2018.5523%2011%2018C11%2017.4477%2011.4477%2017%2012%2017C12.5523%2017%2013%2017.4477%2013%2018Z'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Divide" class="object-fit-cover" />
              </button>
              <button class="calc-btn function" onclick="clearAll()">AC</button>

              <button class="calc-btn number" onclick="inputNumber('4')">
                4
              </button>
              <button class="calc-btn number" onclick="inputNumber('5')">
                5
              </button>
              <button class="calc-btn number" onclick="inputNumber('6')">
                6
              </button>
              <button class="calc-btn operator" onclick="inputOperator('×')">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M18%206L6%2018M6%206L18%2018'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Multiply" class="object-fit-cover" />
              </button>
              <button class="calc-btn function" onclick="backspace()">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M11.9999%209L17.9999%2015M17.9999%209L11.9999%2015M9.99994%205C9.50302%205.00003%209.02391%205.18504%208.65594%205.519L2.32794%2011.259C2.22466%2011.3527%202.14213%2011.467%202.08565%2011.5946C2.02918%2011.7221%202%2011.86%202%2011.9995C2%2012.139%202.02918%2012.2769%202.08565%2012.4044C2.14213%2012.532%202.22466%2012.6463%202.32794%2012.74L8.65594%2018.481C9.02391%2018.815%209.50302%2019%209.99994%2019H19.9999C20.5304%2019%2021.0391%2018.7893%2021.4142%2018.4142C21.7892%2018.0391%2021.9999%2017.5304%2021.9999%2017V7C21.9999%206.46957%2021.7892%205.96086%2021.4142%205.58579C21.0391%205.21071%2020.5304%205%2019.9999%205H9.99994Z'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Backspace" class="object-fit-cover" />
              </button>

              <button class="calc-btn number" onclick="inputNumber('1')">
                1
              </button>
              <button class="calc-btn number" onclick="inputNumber('2')">
                2
              </button>
              <button class="calc-btn number" onclick="inputNumber('3')">
                3
              </button>
              <button class="calc-btn operator" onclick="inputOperator('-')">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M5%2012H19'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Minus" class="object-fit-cover" />
              </button>
              <button class="calc-btn function" onclick="memory()">再記</button>

              <button class="calc-btn number" onclick="inputNumber('00')">
                00
              </button>
              <button class="calc-btn number" onclick="inputNumber('0')">
                0
              </button>
              <button class="calc-btn operator" onclick="inputOperator('.')">
                .
              </button>
              <button class="calc-btn operator" onclick="inputOperator('+')">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M5%2012H19M12%205V19'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Plus" class="object-fit-cover" />
              </button>
              <button class="calc-btn equals" onclick="calculate()">
                <img src="data:image/svg+xml,%3csvg%20width='24'%20height='23'%20viewBox='0%200%2024%2023'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M20%206L9%2017L4%2012'%20stroke='%231A1A1A'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3c/svg%3e" alt="Check" class="object-fit-cover" />
              </button>
              <img src="data:image/svg+xml,%3csvg%20width='343'%20height='34'%20viewBox='0%200%20343%2034'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20width='144'%20height='5'%20rx='2.5'%20transform='matrix(-1%200%200%201%20244%2021)'%20fill='black'/%3e%3c/svg%3e" alt="statusbar"
    class="object-fit-cover position-absolute  bottom-0 start-50 translate-middle-x $zindex-fixed:2000;">            </div>
          </div>
        </div>
      </main>
  </div>

  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- 月曆的js -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1);
      const dd = String(today.getDate());
      const todayFormatted = `${yyyy}/${mm}/${dd}`;

      const fp = flatpickr("#consult_datetime", {
        dateFormat: "Y/m/d",
        defaultDate: todayFormatted,
        allowInput: false,
      });

      document.querySelectorAll(".calendar_icon").forEach((el) => {
        el.addEventListener("click", () => {
          fp.open();
        });
      });
    });
  </script>
  <!-- 月曆的js -->

  <!--計算機-->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const amountInput = document.getElementById("amount");
      const offcanvas = document.getElementById("calculator");
      const partialView = document.getElementById("partialView");
      const calculatorFull = document.getElementById("calculatorFull");
      let isExpanded = false;

      // 🚀 確保載入頁面時不會自動 focus
      amountInput.blur();

      let currentInput = "0",
        operator = "",
        previousInput = "",
        shouldResetDisplay = false;

      // 展開/收合計算機
      function expandCalculator() {
        offcanvas.classList.add("expanded");
        partialView.classList.add("hidden");
        calculatorFull.classList.add("active");
        offcanvas.style.height = "334px";
        isExpanded = true;
        amountInput.classList.add("focused");
      }

      function collapseCalculator() {
        offcanvas.classList.remove("expanded");
        partialView.classList.remove("hidden");
        calculatorFull.classList.remove("active");
        offcanvas.style.height = "106px";
        isExpanded = false;
        amountInput.classList.remove("focused");
      }

      // 事件監聽器
      amountInput.addEventListener("click", (e) => {
        e.stopPropagation();
        expandCalculator();
      });

      amountInput.addEventListener("mousedown", (e) => {
        e.preventDefault();
        document.activeElement.blur();
        expandCalculator();
      });

      partialView.addEventListener("click", (e) => {
        e.stopPropagation();
        expandCalculator();
      });

      document.addEventListener("click", (e) => {
        if (!offcanvas.contains(e.target) && isExpanded) collapseCalculator();
      });

      offcanvas.addEventListener("click", (e) => e.stopPropagation());

      // --- 計算機功能 ---
      function updateInput() {
        amountInput.value = "$" + currentInput;
      }

      function inputNumber(num) {
        let value = currentInput.replace("$", "");
        if (shouldResetDisplay || value === "0") {
          currentInput = num;
          shouldResetDisplay = false;
        } else {
          currentInput += num;
        }
        updateInput();
      }

      function inputOperator(op) {
        if (operator && !shouldResetDisplay) calculate();
        previousInput = currentInput.replace("$", "");
        operator = op;
        shouldResetDisplay = true;
      }

      function calculate() {
        if (!operator || shouldResetDisplay) return;
        let prev = parseFloat(previousInput),
          current = parseFloat(currentInput.replace("$", "")),
          result = 0;
        switch (operator) {
          case "+": result = prev + current; break;
          case "-": result = prev - current; break;
          case "×": result = prev * current; break;
          case "÷": result = prev / current; break;
        }
        currentInput = result.toString();
        operator = "";
        previousInput = "";
        shouldResetDisplay = true;
        updateInput();
      }

      function clearAll() {
        currentInput = "0";
        operator = "";
        previousInput = "";
        shouldResetDisplay = false;
        updateInput();
      }

      function backspace() {
        currentInput = currentInput.length > 1 ? currentInput.slice(0, -1) : "0";
        updateInput();
      }

      function memory() {
        alert("再記: " + currentInput);
      }

      window.inputNumber = inputNumber;
      window.inputOperator = inputOperator;
      window.calculate = calculate;
      window.clearAll = clearAll;
      window.backspace = backspace;
      window.memory = memory;

      window.voiceFunction = () => alert("語音");
      window.qrFunction = () => alert("QR");
      window.saveFunction = () => alert("儲存");

      updateInput(); // 初始化 $0

      // --- 拖曳手勢控制計算機 ---
      let startY = 0;
      let startHeight = 0;
      const minHeight = 106;
      const maxHeight = 334;
      let isDragging = false;

      offcanvas.addEventListener("touchstart", (e) => {
        if (e.touches.length !== 1) return;
        isDragging = true;
        startY = e.touches[0].clientY;
        startHeight = offcanvas.offsetHeight;
      });

      offcanvas.addEventListener("touchmove", (e) => {
        if (!isDragging) return;
        const deltaY = startY - e.touches[0].clientY;
        let newHeight = startHeight + deltaY;

        if (newHeight > maxHeight) newHeight = maxHeight;
        if (newHeight < minHeight) newHeight = minHeight;

        offcanvas.style.height = newHeight + "px";

        if (newHeight > (minHeight + maxHeight) / 2) {
          partialView.classList.add("hidden");
          calculatorFull.classList.add("active");
          amountInput.classList.add("focused");
          isExpanded = true;
        } else {
          partialView.classList.remove("hidden");
          calculatorFull.classList.remove("active");
          amountInput.classList.remove("focused");
          isExpanded = false;
        }
      });

      offcanvas.addEventListener("touchend", () => {
        isDragging = false;
        if (offcanvas.offsetHeight > (minHeight + maxHeight) / 2) {
          expandCalculator();
        } else {
          collapseCalculator();
        }
      });

    });
  </script>

</body>

</html>